<?php
require_once($_SERVER['DOCUMENT_ROOT'] . '/../lib0904/simple/Database.php');

/**
 * Softbank
 *
 * @author DeguchiTatsuya
 * @version 1.0
 * 
 */
class Softbank {

	var $db;
	var $db_url;
	var $uid;

	function Softbank() {
		if($_SERVER['HTTP_X_JPHONE_UID']) {
			$this->uid = $_SERVER['HTTP_X_JPHONE_UID'];
			$this->uid = substr($this->uid, 1);
			
			if(strlen($this->uid) != 15) {
				echo '本コンテンツをご利用になる場合は、ユーザIDを通知する必要がございます。';
				exit();
			}
		} else {
			echo '本コンテンツをご利用になる場合は、ユーザIDを通知する必要がございます。';
			exit();
		}

		// softbankの認証などはこちらの情報を使う。DatabaseActionのものではない。
		$this->db_url = 'pgsql://funkyjam:funkyjam@localhost:5432/fj_db_test';
		if($_SERVER['HTTP_HOST'] == 'm.funkyjam.com') {
			$this->db_url = 'pgsql://funkyjam:funkyjam@localhost:5432/fj_db';
		}
		$this->db = new Database($this->db_url);
		$this->db->connect();
	}

	/**
	 * check support device user agent
	 *
	 * @return boolean
	 */
	function checkSupportUA() {
		if($_SERVER['HTTP_USER_AGENT']) {
		} else {
			return false;
		}

		// 3G携帯ならOKとする。
		// 「SoftBank」か「Vodafone」「MOT-」で始まるUA
		if(preg_match('/^SoftBank/', $_SERVER['HTTP_USER_AGENT']) || preg_match('/^Vodafone/', $_SERVER['HTTP_USER_AGENT']) || preg_match('/^MOT-/', $_SERVER['HTTP_USER_AGENT'])) {
			return true;
		}
		return false;
	}

	/**
	 * check FlashLite1.1 up support device user agent
	 *
	 * @return boolean
	 */
	function checkFlashSupportUA() {
		if($_SERVER['HTTP_USER_AGENT']) {
		} else {
			return false;
		}

		if(preg_match('/^MOT-/', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V702NK\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V702NK2\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V703N\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/705N\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/705NK\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/705P\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/705SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V705T\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/706N\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/706P\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/706SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/707SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/707SC2\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/708SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/709SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/731SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/740SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V802N\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V803T\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V804N\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V804NK\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V804SS\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/805SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/830SC\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V902T\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V903T\//', $_SERVER['HTTP_USER_AGENT'])
			|| preg_match('/V904T\//', $_SERVER['HTTP_USER_AGENT'])) {
		} else {
			return true;
		}
		return false;
	}

	/**
	 * authentication request
	 *
	 * @param String $ok_url
	 * @param String $ng_url
	 */
	function auth($ok_url = null, $ng_url = null) {
		$db =& $this->db;
		$db->assign('uid', $this->uid);
		$result = $db->statement(dirname(__FILE__) . '/../sql/auth.sql');
		
		$row = $db->fetch_assoc($result);
		if(isset($row['uid'])) {
			$location = sprintf('Location: %s', $ok_url);
			header($location);
			exit();
		};

		// P45108Eは、解約済みの場合に出力されるエラーコード
		$ng_code = 'P45108E';
		$location = sprintf('Location: %s&ncd=%s', $ng_url, $ng_code);
		header($location);
		exit();
	}

	/**
	 *
	 * @param String $paramName
	 * @return mixed
	 */
	function getParam($paramName) {
		if($this->$paramName) {
			return $this->$paramName;
		}
		return false;
	}

	/**
	 * check ip address
	 *
	 * @return boolean
	 */
	function checkIP() {
		if($_SERVER['REMOTE_ADDR']) {
		} else {
			return false;
		}

		// softbankのゲートウェイのIP一覧
		$IPList = array(
			'123.108.237.1' => '', '123.108.237.2' => '', '123.108.237.3' => '', '123.108.237.4' => '', '123.108.237.5' => '', '123.108.237.6' => '',
			'123.108.237.7' => '', '123.108.237.8' => '', '123.108.237.9' => '', '123.108.237.10' => '', '123.108.237.11' => '', '123.108.237.12' => '',
			'123.108.237.13' => '', '123.108.237.14' => '', '123.108.237.15' => '', '123.108.237.16' => '', '123.108.237.17' => '', '123.108.237.18' => '',
			'123.108.237.19' => '', '123.108.237.20' => '', '123.108.237.21' => '', '123.108.237.22' => '', '123.108.237.23' => '', '123.108.237.24' => '',
			'123.108.237.25' => '', '123.108.237.26' => '', '123.108.237.27' => '', '123.108.237.28' => '', '123.108.237.29' => '', '123.108.237.30' => '',
			'202.253.96.225' => '', '202.253.96.226' => '', '202.253.96.227' => '', '202.253.96.228' => '', '202.253.96.229' => '', '202.253.96.230' => '',
			'202.253.96.231' => '', '202.253.96.232' => '', '202.253.96.233' => '', '202.253.96.234' => '', '202.253.96.235' => '', '202.253.96.236' => '',
			'202.253.96.237' => '', '202.253.96.238' => '', '202.253.96.239' => '', '202.253.96.240' => '', '202.253.96.241' => '', '202.253.96.242' => '',
			'202.253.96.243' => '', '202.253.96.244' => '', '202.253.96.245' => '', '202.253.96.246' => '', '202.253.96.247' => '', '202.253.96.248' => '',
			'202.253.96.249' => '', '202.253.96.250' => '', '202.253.96.251' => '', '202.253.96.252' => '', '202.253.96.253' => '', '202.253.96.254' => '',
			'210.146.7.193' => '', '210.146.7.194' => '', '210.146.7.195' => '', '210.146.7.196' => '', '210.146.7.197' => '', '210.146.7.198' => '',
			'210.146.7.199' => '', '210.146.7.200' => '', '210.146.7.201' => '', '210.146.7.202' => '', '210.146.7.203' => '', '210.146.7.204' => '',
			'210.146.7.205' => '', '210.146.7.206' => '', '210.146.7.207' => '', '210.146.7.208' => '', '210.146.7.209' => '', '210.146.7.210' => '',
			'210.146.7.211' => '', '210.146.7.212' => '', '210.146.7.213' => '', '210.146.7.214' => '', '210.146.7.215' => '', '210.146.7.216' => '',
			'210.146.7.217' => '', '210.146.7.218' => '', '210.146.7.219' => '', '210.146.7.220' => '', '210.146.7.221' => '', '210.146.7.222' => '',
			'210.146.7.223' => '', '210.146.7.224' => '', '210.146.7.225' => '', '210.146.7.226' => '', '210.146.7.227' => '', '210.146.7.228' => '',
			'210.146.7.229' => '', '210.146.7.230' => '', '210.146.7.231' => '', '210.146.7.232' => '', '210.146.7.233' => '', '210.146.7.234' => '',
			'210.146.7.235' => '', '210.146.7.236' => '', '210.146.7.237' => '', '210.146.7.238' => '', '210.146.7.239' => '', '210.146.7.240' => '',
			'210.146.7.241' => '', '210.146.7.242' => '', '210.146.7.243' => '', '210.146.7.244' => '', '210.146.7.245' => '', '210.146.7.246' => '',
			'210.146.7.247' => '', '210.146.7.248' => '', '210.146.7.249' => '', '210.146.7.250' => '', '210.146.7.251' => '', '210.146.7.252' => '',
			'210.146.7.253' => '', '210.146.7.254' => '',
			'210.175.1.129' => '', '210.175.1.130' => '', '210.175.1.131' => '', '210.175.1.132' => '', '210.175.1.133' => '', '210.175.1.134' => '',
			'210.175.1.135' => '', '210.175.1.136' => '', '210.175.1.137' => '', '210.175.1.138' => '', '210.175.1.139' => '', '210.175.1.140' => '',
			'210.175.1.141' => '', '210.175.1.142' => '', '210.175.1.143' => '', '210.175.1.144' => '', '210.175.1.145' => '', '210.175.1.146' => '',
			'210.175.1.147' => '', '210.175.1.148' => '', '210.175.1.149' => '', '210.175.1.150' => '', '210.175.1.151' => '', '210.175.1.152' => '',
			'210.175.1.153' => '', '210.175.1.154' => '', '210.175.1.155' => '', '210.175.1.156' => '', '210.175.1.157' => '', '210.175.1.158' => '',
			'210.175.1.159' => '', '210.175.1.160' => '', '210.175.1.161' => '', '210.175.1.162' => '', '210.175.1.163' => '', '210.175.1.164' => '',
			'210.175.1.165' => '', '210.175.1.166' => '', '210.175.1.167' => '', '210.175.1.168' => '', '210.175.1.169' => '', '210.175.1.170' => '',
			'210.175.1.171' => '', '210.175.1.172' => '', '210.175.1.173' => '', '210.175.1.174' => '', '210.175.1.175' => '', '210.175.1.176' => '',
			'210.175.1.177' => '', '210.175.1.178' => '', '210.175.1.179' => '', '210.175.1.180' => '', '210.175.1.181' => '', '210.175.1.182' => '',
			'210.175.1.183' => '', '210.175.1.184' => '', '210.175.1.185' => '', '210.175.1.186' => '', '210.175.1.187' => '', '210.175.1.188' => '',
			'210.175.1.189' => '', '210.175.1.190' => '', '210.175.1.191' => '', '210.175.1.192' => '', '210.175.1.193' => '', '210.175.1.194' => '',
			'210.175.1.195' => '', '210.175.1.196' => '', '210.175.1.197' => '', '210.175.1.198' => '', '210.175.1.199' => '', '210.175.1.200' => '',
			'210.175.1.201' => '', '210.175.1.202' => '', '210.175.1.203' => '', '210.175.1.204' => '', '210.175.1.205' => '', '210.175.1.206' => '',
			'210.175.1.207' => '', '210.175.1.208' => '', '210.175.1.209' => '', '210.175.1.210' => '', '210.175.1.211' => '', '210.175.1.212' => '',
			'210.175.1.213' => '', '210.175.1.214' => '', '210.175.1.215' => '', '210.175.1.216' => '', '210.175.1.217' => '', '210.175.1.218' => '',
			'210.175.1.219' => '', '210.175.1.220' => '', '210.175.1.221' => '', '210.175.1.222' => '', '210.175.1.223' => '', '210.175.1.224' => '',
			'210.175.1.225' => '', '210.175.1.226' => '', '210.175.1.227' => '', '210.175.1.228' => '', '210.175.1.229' => '', '210.175.1.230' => '',
			'210.175.1.231' => '', '210.175.1.232' => '', '210.175.1.233' => '', '210.175.1.234' => '', '210.175.1.235' => '', '210.175.1.236' => '',
			'210.175.1.237' => '', '210.175.1.238' => '', '210.175.1.239' => '', '210.175.1.240' => '', '210.175.1.241' => '', '210.175.1.242' => '',
			'210.175.1.243' => '', '210.175.1.244' => '', '210.175.1.245' => '', '210.175.1.246' => '', '210.175.1.247' => '', '210.175.1.248' => '',
			'210.175.1.249' => '', '210.175.1.250' => '', '210.175.1.251' => '', '210.175.1.252' => '', '210.175.1.253' => '', '210.175.1.254' => '',
			'61.197.253.57' => '', '61.197.253.58' => '', '61.197.253.59' => '', '61.197.253.60' => '', '61.197.253.61' => '', '61.197.253.62' => '', //2012/02/09 add
			'123.108.237.113' => '', '123.108.237.114' => '', '123.108.237.115' => '', '123.108.237.116' => '', '123.108.237.117' => '', '123.108.237.118' => '', //2012/02/09 add
			'123.108.237.119' => '', '123.108.237.120' => '', '123.108.237.121' => '', '123.108.237.122' => '', '123.108.237.123' => '','123.108.237.124' => '', //2012/02/09 add
			'123.108.237.125' => '', '123.108.237.126' => '', //2012/02/09 add
			'123.108.239.225' => '', '123.108.239.226' => '', '123.108.239.227' => '', '123.108.239.228' => '', '123.108.239.229' => '', '123.108.239.230' => '', //2012/02/09 add
			'123.108.239.231' => '', '123.108.239.232' => '', '123.108.239.233' => '','123.108.239.234' => '', '123.108.239.235' => '', '123.108.239.236' => '', //2012/02/09 add
			'123.108.239.237' => '', '123.108.239.238' => '', //2012/02/09 add
			'202.253.96.145' => '', '202.253.96.146' => '', '202.253.96.147' => '', '202.253.96.148' => '', '202.253.96.149' => '', '202.253.96.150' => '', //2012/02/09 add
			'202.253.96.151' => '', '202.253.96.152' => '', '202.253.96.153' => '', '202.253.96.154' => '', '202.253.96.155' => '', '202.253.96.156' => '', //2012/02/09 add
			'202.253.96.157' => '', '202.253.96.158' => '', //2012/02/09 add
			'202.253.99.145' => '', '202.253.99.146' => '', '202.253.99.147' => '', '202.253.99.148' => '', '202.253.99.149' => '', '202.253.99.150' => '', //2012/02/09 add
			'202.253.99.151' => '', '202.253.99.152' => '', '202.253.99.153' => '', '202.253.99.154' => '', '202.253.99.155' => '', '202.253.99.156' => '', //2012/02/09 add
			'202.253.99.157' => '', '202.253.99.158' => '', //2012/02/09 add
			'210.228.189.189' => '', '210.228.189.190' => '', //2012/02/09 add
		);

		// softbankのゲートウェイIPならばOKとする。
		if(array_key_exists($_SERVER['REMOTE_ADDR'], $IPList)) {
			return true;
		}
		return false;
	}
}
?>
